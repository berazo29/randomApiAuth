# This workflow will do a clean install of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

on:
  push:
    branches: [ development ]

jobs:
  build:
    env:
      DB_HOST: localhost
      DB_USER: root
      DB_PASSWORD: simplepassword
      DB_NAME: test_db
      DB_PORT: 3306
      SESSION_SECRET: this-is-a-testing-secret
      SESSION_MAX_AGE: 360000
      SERVER_PORT: 3000
      BCRYPT_SALT: 10
      NODE_ENV: development

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [17.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
    - name: Run mysql container
    - run: docker run --detach --name=$DB_NAME --env="MYSQL_ROOT_PASSWORD=$DB_PASSWORD" --publish $DB_PORT:3306 mysql:8

    - name: Run redis container
    - run: docker run --name some-redis -p 6379:6379 -d redis

    - name: Install dependencies and sanitize folders
    - run: npm install -g yarn
    - run: rm -rf node_modules
    - run: yarn install --frozen-lockfile

    - name: Run tests
    - run: yarn test

    - name: Clean yarn
    - run: npm uninstall -g yarn
